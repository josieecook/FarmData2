<!-- define a div to wrqp around the app. -->
<!-- apply v-cloak so that app is not visible until after being rendered -->
<div id="ex1" v-cloak>
 
    <p>UserID: <span data-cy="user-id">{{ userID }}</span></p>
    <p>UserName: <span data-cy="user-name">{{ userName }}</span></p>

    <!-- Example of a v-model binding -->
    <p>Type comment: <input data-cy="comment-field" type='text' v-model='comment'>
    <p>Comment: <span data-cy="comment">{{ comment }}</span></p>

    <!-- Example of event handling and api call -->
    <p><button data-cy="get-name-button" @click='getFarmName'>Get Farm Name</button></p>
    <p>Farm Name: <span data-cy="farm-name">{{ farm }}</span></p>

    <!-- Exmaple of using a Vue Component -->
    <!-- the date-selection and date-range-selection components are defined in ../resources/DateSelectionComponent.js  and ../resources/DateRangeSelectionComponent.js -->
     <!-- That file is imported by the fd2_example.info file -->
    <date-selection default-date="2021-06-08" latest-date="2022-12-31" earliest-date="2020-01-01"></date-selection>

    <br>

    <date-range-selection default-start-date="2021-02-01" default-end-date="2021-11-01"></date-range-selection>

    <!-- the dropdown-with-all component is defined in ../resources/dropdownWithAllComponent.js -->
     <!-- That file is imported by the fd2_example.info file -->
    <dropdown-with-all includes-all @selection-changed='fieldChange' :dropdown-list=fieldList></dropdown-with-all>
    <p>Chosen Field: <span data-cy="selected-field">{{selectedField}}</span></p>
    <br>
  
    <custom-table :headers="testArray" :rows="testObjectArray" can-edit can-delete @delete-row="deleteFromTestObjectArray" @finish-row-edit="updateTestObjectArray"></custom-table>

    <br>

    <button @click="recursiveRequest('/log.json?type=farm_seeding')">Push</button>

<br>

    <div class="progress">
        <div class="progress-bar" role="progressbar" v-model:aria-valuenow="progressBarPercentage" aria-valuemin="0" aria-valuemax="100"></div>
    </div>

</div>

<script>
// Define the Vue instance for the app.
// el: must match the id of the <div> for the app above.
// Note: The JS variables fd2UserID and fd2UserName are defined in fd2_example.module
new Vue({
    el: '#ex1',
    components: {
        // Register the components that are being used.
        'date-selection': DateSelectionComponent,
        'date-range-selection': DateRangeSelectionComponent,
        customTable: CustomTableComponent,
        'dropdown-with-all': DropdownWithAllComponent
    },
    data: {
        wholeResponse: null,
	    comment: null,
        farm: null,
        selectedField: null,
        fieldList: [],
        userID: fd2UserID,
        userName: fd2UserName,
        testArray: ['cool', 'works?', 'hello'],
        testObjectArray: [
            {id: 10, 
            data: [12, 3, 'answome']},
            {id: 11,
            data: [19, 3, 'ansekjdwome'],},
            {id: 12,
            data: [12, 12, 'answome12'],},
        ],
        multipageResponse: [],
        progressBarPercentage: 0
    },
    created() {
        axios
        .get('/taxonomy_term.json?bundle=farm_areas')
        .then(response => {
            this.fieldList = response.data.list.map(
                function(f) { return f.name }
            );
            this.fieldList.sort();
        })
        .catch(error => {
            this.fieldList = [ 'Server error' ]
            console.log(error)
        })
    },
    methods: {
        getFarmName() {
            axios
            .get('/farm.json')
            .then(response => (this.farm = response.data.name))
            .catch(error => console.log(error))
        },
        fieldChange(newField) {
            this.selectedField = newField;
        },
        updateTestObjectArray(newObject){
            for(i=0; i < this.testObjectArray.length; i++){
                if(array[i].id === newObject.id){
                    this.testObjectArray.splice(i, 1, newObject)
                }
            }
        },
        deleteFromTestObjectArray(deletedObjectID){
            for(var i=0; i < this.testObjectArray.length; i++){
                if(this.testObjectArray[i].id === deletedObjectID){
                    this.testObjectArray.splice(i, 1)
                }
            }
        },
        fieldChange(selectedOption) {
            this.selectedField = selectedOption;
        },
        recursiveRequest: function(url) {
            requestURL = url
                axios.get(requestURL)
                    .then(response => {
                        next = response.data.next
                        
                        this.multipageResponse = [].concat(this.multipageResponse, response.data.list);

                        if (typeof next == 'undefined') {
                            //do nothing, all done!
                        }
                        else {
                            fullRequestURL = response.data.next
                            requestURL = fullRequestURL.substring(16, fullRequestURL.length);

                            lastRequestURL = response.data.last
                            last = lastRequestURL.substring(16, lastRequestURL.length);

                            this.recursiveRequest(requestURL);
                        }
                })
        },
        progressBarUpdate: function(currentPage, lastPage) {
            //current = parseInt(currentPage.substring(currentpage.length))
            //last = parseInt(lastPage.substring(lastPage.length))
            //percent = Math.floor(current / last)
            this.progressBarPercentage = this.progressBarPercentage + 20
        }
    }
})

Vue.config.devtools = true;
</script>